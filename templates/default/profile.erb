RDECK_INSTALL=<%=@rundeck[:basedir]%>
RDECK_BASE=<%=@rundeck[:basedir]%>
RDECK_CONFIG=<%=@rundeck[:configdir]%>
RDECK_SERVER_BASE="$RDECK_BASE"
RDECK_SERVER_CONFIG="$RDECK_CONFIG"
RDECK_SERVER_DATA="$RDECK_BASE/data"
RDECK_PROJECTS="$RDECK_BASE/projects"
RUNDECK_TEMPDIR=<%=@rundeck[:tempdir]%>
RUNDECK_WORKDIR="$RDECK_BASE/work"
RUNDECK_LOGDIR="$RDECK_BASE/logs"
RDECK_JVM_SETTINGS="<%=@rundeck[:jvm_mem]%> -server"
RDECK_TRUSTSTORE_FILE="$RDECK_CONFIG/ssl/truststore}"
RDECK_TRUSTSTORE_TYPE="jks"
JAAS_CONF="$RDECK_CONFIG/jaas-loginmodule.conf"
LOGIN_MODULE="RDpropertyfilelogin"
RDECK_HTTP_PORT=<%=@rundeck[:port]%>
RDECK_HTTPS_PORT=<%=@rundeck[:ssl][:port]%>


# If no JAVA_CMD, try to find it in $JAVA_HOME
if [ -z "$JAVA_CMD" ] && [ -n "$JAVA_HOME" ] && [ -x "$JAVA_HOME/bin/java" ] ; then
  JAVA_CMD=$JAVA_HOME/bin/java
  PATH=$PATH:$JAVA_HOME/bin
  export JAVA_HOME
elif [ -z "$JAVA_CMD" ] ; then
  JAVA_CMD=java
fi

# build classpath without lone : that includes .
for jar in $(find $RDECK_INSTALL/cli -name '*.jar') ; do
  CLI_CP=${CLI_CP:+$CLI_CP:}$jar
done
for jar in $(find $RDECK_INSTALL/bootstrap -name '*.jar') ; do
  BOOTSTRAP_CP=${BOOTSTRAP_CP:+$BOOTSTRAP_CP:}$jar
done

RDECK_JVM="-Djava.security.auth.login.config=$JAAS_CONF \
           -Dloginmodule.name=$LOGIN_MODULE \
           -Drdeck.config=$RDECK_CONFIG \
           -Drundeck.server.configDir=$RDECK_SERVER_CONFIG \
           -Dserver.datastore.path=$RDECK_SERVER_DATA/rundeck \
           -Drundeck.server.serverDir=$RDECK_INSTALL \
           -Drdeck.projects=$RDECK_PROJECTS \
           -Drdeck.runlogs=$RUNDECK_LOGDIR \
           -Drundeck.config.location=$RDECK_CONFIG/rundeck-config.properties \
           -Djava.io.tmpdir=$RUNDECK_TEMPDIR \
           -Drundeck.server.workDir=$RUNDECK_WORKDIR \
           -Dserver.http.port=$RDECK_HTTP_PORT"
#
# Set min/max heap size
#
RDECK_JVM="$RDECK_JVM $RDECK_JVM_SETTINGS"
#
# SSL Configuration - Uncomment the following to enable.  Check SSL.properties for details.
#
if [ -n "$RUNDECK_WITH_SSL" ] ; then
  RDECK_SSL_OPTS="${RDECK_SSL_OPTS:- -Djavax.net.ssl.trustStore=$RDECK_TRUSTSTORE_FILE -Djavax.net.ssl.trustStoreType=$RDECK_TRUSTSTORE_TYPE -Djava.protocol.handler.pkgs=com.sun.net.ssl.internal.www.protocol}"
  RDECK_JVM="$RDECK_JVM -Drundeck.ssl.config=$RDECK_SERVER_CONFIG/ssl/ssl.properties -Dserver.https.port=${RDECK_HTTPS_PORT} ${RDECK_SSL_OPTS}"
fi

unset JRE_HOME

umask 002

rundeckd="$JAVA_CMD $RDECK_JVM $RDECK_JVM_OPTS -cp $BOOTSTRAP_CP com.dtolabs.rundeck.RunServer $RDECK_BASE"
